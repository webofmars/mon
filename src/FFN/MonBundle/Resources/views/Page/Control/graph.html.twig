{% extends 'FFNMonBundle::layout.html.twig' %}

{% block metarefresh %}
  <meta http-equiv="refresh" content="1800;url={{ path('mon_graph_simple', { 'control_id': id }) }}">
{% endblock %}

{% block body %}

  <div class="container">
    {% include 'FFNMonBundle:Common:project_headerbar.html.twig' %}
  </div>

  <script type="text/javascript" src="https://www.google.com/jsapi"></script>

  {% autoescape('js') %}
  <script type="text/javascript">
    google.load("visualization", "1", {packages:["corechart"]});
    google.setOnLoadCallback(drawChart);
    function drawChart() {
      var data = google.visualization.arrayToDataTable([
              [
                '{{ 'mon_graph_date' | trans({}, 'messages') | raw }}',
                '{{ 'mon_graph_dns_resolution' | trans({}, 'messages') | raw }}',
                '{{ 'mon_graph_tcp_connection' | trans({}, 'messages') | raw }}',
                '{{ 'mon_graph_first_packet' | trans({}, 'messages') | raw }}',
                '{{ 'mon_graph_total_time' | trans({}, 'messages') | raw }}'
              ],
              {% for row in graphdata %}
                  [
                      {{ row.dateExecuted | date('H:i:s', timezone) | json_encode() | replace( {'"': '\''} ) | raw() }},
                      {{ row.dns | json_encode() | replace( {'"': ''} ) | raw() }},
                      {{ row.tcp | json_encode() | replace( {'"': ''} ) | raw() }},
                      {{ row.firstPacket | json_encode() | replace( {'"': ''} ) | raw() }},
                      {{ row.total | json_encode() | replace( {'"': ''} ) | raw() }}            
                  ],
              {% else %}
                  [ '' ]
              {% endfor %}
          ]
      );

      var options = {
        //title: 'URL response time',
        hAxis: {title: 'Time',  titleTextStyle: {color: 'red'}},
        isStacked: false,
        vAxis: {title: "Time (s)"},
        hAxis: {title: "Date"}
      };

      var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
      chart.draw(data, options);
    }
  </script>
  {% endautoescape %}

  {# Google chart #}
  <div class="container">
    <h1><small>{{ 'mon_graph_label' | trans({}, 'messages') }} {{ title }}</small></h1>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
    <div>
      <em>{{ 'mon_graph_interval_sentence_1' | trans }} {{ start | date('d/m/Y H:i:s', timezone) }} {{ 'mon_graph_interval_sentence_2' | trans }} {{ stop | date('d/m/Y H:i:s', timezone)}} ({{ timezone }})</em>
    </div>      
    
    {# A refresh button to actualize the data #}
    <div>
        <input class="btn btn-primary" type="button" OnClick="javascript:window.location = '{{ path('mon_graph_simple', { 'control_id': id }) }}';" id="_graph_refresh" name="_graph_refresh" value="{{ 'mon_graph_refresh_button'|trans }}" />
    </div>
    <br/>  
  </div>
  {# end Google chart #}
  
  {# Data table #}
  <div class="container">
    <div class="row">
      <h2><i class="icon-hdd" style="vertical-align:middle;"></i>&nbsp;{{ 'mon_graph_detail' | trans({}, 'messages') | raw() }}</h2>
    </div>
    <div class="row">
      <table class="table table-striped table-hover table-bordered">
        <thead>
          <tr>
            <th>{{ 'mon_graph_execution_date' | trans }}</th>
            <th>{{ 'mon_graph_dns_resolution' | trans }}</th>
            <th>{{ 'mon_graph_tcp_connection' | trans }}</th>
            <th>{{ 'mon_graph_first_packet'   | trans }}</th>
            <th>{{ 'mon_graph_total_time'     | trans }}</th>
            <th>{{ 'mon_graph_valid'          | trans }}</th>
            <th>{{ 'mon_graph_timeout'        | trans }}</th>
          </tr>
        </thead>
      {% for row in graphdata %}
        {% if ((row.isValid == true) and (row.isTimeout == false)) %}
            {% set classType = 'success' %}
        {% else %}
            {% set classType = 'error' %}
        {% endif %}
        
            <tr class="{{ classType }}" onClick="javascript: window.location = '{{ path('mon_capture_details_show', { 'id': capture_detail.id }) }}';">
              <td>{{ row.dateExecuted | date('d/m/Y H:i:s', timezone)}}</td>
              <td>{{ row.dns }}</td>
              <td>{{ row.tcp }}</td>
              <td>{{ row.firstPacket }}</td>
              <td>{{ row.total }}</td>
              <td>{% if (row.isValid == true) %}Yes{% else %}No{% endif %}</td>
              <td>{% if (row.isTimeout == true) %}Yes{% else %}No{% endif %}</td>
            </tr>
      {% endfor %}
      </table>
    </div>
  </div>
  {# end Data table #}

{% endblock %}