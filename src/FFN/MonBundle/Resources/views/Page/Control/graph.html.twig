{% extends 'FFNMonBundle::layout.html.twig' %}

{% block metarefresh %}
  <meta http-equiv="refresh" content="1800; url={{ path('mon_graph_simple', { 'control_id': id }) }}">
{% endblock %}

{% block body %}

  <div class="container">
    {% include 'FFNMonBundle:Common:project_headerbar.html.twig' %}
  </div>

  <script type="text/javascript" src="https://www.google.com/jsapi"></script>

  {% autoescape('js') %}
  <script type="text/javascript">
    google.load("visualization", "1", {packages:["corechart"]});
    google.setOnLoadCallback(drawChart);
    function drawChart() {
      var data = google.visualization.arrayToDataTable([
              [
                '{{ 'mon_graph_date' | trans({}, 'messages') | raw }}',
                '{{ 'mon_graph_dns_resolution' | trans({}, 'messages') | raw }}',
                '{{ 'mon_graph_tcp_connection' | trans({}, 'messages') | raw }}',
                '{{ 'mon_graph_first_packet' | trans({}, 'messages') | raw }}',
                '{{ 'mon_graph_total_time' | trans({}, 'messages') | raw }}'
              ],
              {% for row in graphdata %}
                  [
                      {{ row.dateExecuted | date('H:i:s', timezone) | json_encode() | replace( {'"': '\''} ) | raw() }},
                      {{ row.dns | json_encode() | replace( {'"': ''} ) | raw() }},
                      {{ row.tcp | json_encode() | replace( {'"': ''} ) | raw() }},
                      {{ row.firstPacket | json_encode() | replace( {'"': ''} ) | raw() }},
                      {{ row.total | json_encode() | replace( {'"': ''} ) | raw() }}            
                  ],
              {% else %}
                  [ '' ]
              {% endfor %}
          ]
      );

      var options = {
        //title: 'URL response time',
        hAxis: {title: 'Time',  titleTextStyle: {color: 'red'}},
        isStacked: false,
        vAxis: {title: "Time (s)"},
        hAxis: {title: "Date"}
      };

      var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
      chart.draw(data, options);
    }
  </script>
  {% endautoescape %}

  {# Google chart #}
  <div class="container">
    <h1><small>{{ 'mon_graph_label' | trans({}, 'messages') }} {{ title }}</small></h1>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
    <div>
      <em>{{ 'mon_graph_interval_sentence_1' | trans }} {{ start | date('d/m/Y H:i:s', timezone) }} {{ 'mon_graph_interval_sentence_2' | trans }} {{ stop | date('d/m/Y H:i:s', timezone)}} ({{ timezone }})</em>
    </div>      
    
    {# A refresh button to actualize the data #}
    <div>
        <input class="btn btn-primary" type="button" OnClick="javascript:window.location = '{{ path('mon_graph_simple', { 'control_id': id }) }}';" id="_graph_refresh" name="_graph_refresh" value="{{ 'mon_graph_refresh_button'|trans }}" />
    </div>
    <br/>  
  </div>
  {# end Google chart #}
  
  {# Data table #}
  <div class="container">
    <div class="row">
      <table id="capstable" class="table tablesorter">
        <caption><h2>{{ 'mon_graph_detail' | trans }}</h2></caption>
        <thead>
          <tr>
            <th class="header headerSortDown">{{ 'mon_graph_execution_date' | trans }}</th>
            <th class="header">{{ 'mon_graph_dns_resolution' | trans }}</th>
            <th class="header">{{ 'mon_graph_tcp_connection' | trans }}</th>
            <th class="header">{{ 'mon_graph_first_packet'   | trans }}</th>
            <th class="header">{{ 'mon_graph_total_time'     | trans }}</th>
            <th class="header">{{ 'mon_graph_valid'          | trans }}</th>
            <th class="header">{{ 'mon_graph_timeout'        | trans }}</th>
          </tr>
        </thead>
        <tbody>
          {% for row in graphdata %}
            {% if ((row.isValid == true) and (row.isTimeout == false)) %}
              {% set classType = 'success' %}
            {% else %}
              {% set classType = 'error' %}
            {% endif %}
        
            <tr title="{{ 'mon_click_to_see_capture_details' | trans }}" class="{{ classType }}" style= "cursor: pointer;" onClick="javascript: window.location = '{{ path('mon_capture_show', { 'id': capture.id }) }}';">
              <td>{{ row.dateExecuted | date('d/m/Y H:i:s', timezone)}}</td>
              <td>{{ row.dns }}</td>
              <td>{{ row.tcp }}</td>
              <td>{{ row.firstPacket }}</td>
              <td>{{ row.total }}</td>
              <td>{% if (row.isValid == true) %}Yes{% else %}No{% endif %}</td>
              <td>{% if (row.isTimeout == true) %}Yes{% else %}No{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="pager" class="pagination-centered">
    <form>  
		<img src="{{ asset('bundles/ffnmon/images/first.png') }}" class="first" title="{{ 'pager_first' | trans }}">
		<img src="{{ asset('bundles/ffnmon/images/prev.png') }}" class="prev" title="{{ 'pager_prev' | trans }}">
		<input class="pagedisplay" type="text">
		<img src="{{ asset('bundles/ffnmon/images/next.png') }}" class="next" title="{{ 'pager_next' | trans }}">
		<img src="{{ asset('bundles/ffnmon/images/last.png') }}" class="last" title="{{ 'pager_last' | trans }}">
        <br>
        {{ 'pager_max_elts' | trans }} :
        <br>
        <select class="pagesize">
			<option selected="selected" value="10">10</option>
			<option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
		</select>
	</form>
    </div>
  </div>
  {# end Data table #}

{% endblock %}
  
{% block javascripts %}
  {{ parent() }}
  <script  type="text/javascript">
    $(document).ready(sortAndPageTable('capstable','pager'));
  </script>
{% endblock %}